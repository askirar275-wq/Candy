<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Level Complete — Candy Match</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* small local tweaks for the Game Over card */
    .result-card { max-width:520px; margin:28px auto; padding:20px; text-align:center; border-radius:14px; }
    .score-big { font-size:36px; font-weight:700; margin:6px 0; color:#0b63a8; }
    .best-small { color:#666; margin-bottom:10px; }
    .stars-large { font-size:34px; color:#f0c419; margin:8px 0 16px; }
    .result-row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:12px; }
    .muted { color:#666; font-size:13px; margin-top:8px; }
  </style>
</head>
<body>
  <main class="container">
    <section class="card result-card" aria-labelledby="resultTitle">
      <h2 id="resultTitle">Level Complete!</h2>

      <div id="starWrap" class="stars-large" aria-hidden="true">☆☆☆</div>

      <div>
        <div class="score-big" id="finalScore">0</div>
        <div class="best-small">Best: <strong id="bestScore">0</strong></div>
      </div>

      <div class="result-row">
        <a id="replayBtn" class="btn" href="#">Replay</a>
        <a id="nextBtn" class="btn" href="#">Next</a>
        <a id="mapBtn" class="btn" href="map.html">Map</a>
      </div>

      <div class="muted" id="levelMetaNote"></div>
    </section>
  </main>

  <script src="js/storage.js"></script>
  <script>
    (function(){
      // same meta used elsewhere (keeps star thresholds consistent)
      const LEVEL_META = {
        1: { target: 600, star2: 1000, star3: 1600 },
        2: { target: 800, star2: 1400, star3: 2000 },
        default: { target: 1200, star2: 2200, star3: 3200 }
      };
      function getMeta(l){ return LEVEL_META[l] || LEVEL_META.default; }

      function getParam(name){
        return new URL(location.href).searchParams.get(name);
      }

      const level = parseInt(getParam('level') || '1', 10);
      const score = parseInt(getParam('score') || '0', 10);

      // DOM
      const finalScoreEl = document.getElementById('finalScore');
      const bestScoreEl  = document.getElementById('bestScore');
      const starWrapEl    = document.getElementById('starWrap');
      const replayBtn     = document.getElementById('replayBtn');
      const nextBtn       = document.getElementById('nextBtn');
      const mapBtn        = document.getElementById('mapBtn');
      const metaNoteEl    = document.getElementById('levelMetaNote');

      // show final
      finalScoreEl.textContent = score;

      // save best score
      const bestKey = 'best_' + level;
      const prevBest = parseInt(localStorage.getItem(bestKey) || '0', 10);
      if(score > prevBest){
        localStorage.setItem(bestKey, String(score));
      }
      const newBest = parseInt(localStorage.getItem(bestKey) || '0', 10);
      bestScoreEl.textContent = newBest;

      // compute stars
      const meta = getMeta(level);
      let stars = 0;
      if(score >= meta.target) stars = 1;
      if(score >= meta.star2) stars = 2;
      if(score >= meta.star3) stars = 3;

      // render star icons
      const filled = '★', empty = '☆';
      starWrapEl.textContent = filled.repeat(stars) + empty.repeat(3 - stars);

      // friendly note about target
      metaNoteEl.textContent = `Level ${level} — Targets: ${meta.target} / ${meta.star2} / ${meta.star3} (1★ • 2★ • 3★)`;

      // unlock next level in progress storage
      Storage.unlock(level + 1);

      // Buttons
      replayBtn.href = `game.html?level=${level}`;
      nextBtn.href   = `game.html?level=${level + 1}`;
      mapBtn.href    = 'map.html';

      // small keyboard support: press R to replay, N for next, M for map
      window.addEventListener('keydown', (e) => {
        if(e.key === 'r' || e.key === 'R') location.href = replayBtn.href;
        if(e.key === 'n' || e.key === 'N') location.href = nextBtn.href;
        if(e.key === 'm' || e.key === 'M') location.href = mapBtn.href;
      });
    })();
  </script>
</body>
</html>
