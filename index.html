<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ChatApp</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{height:100vh;background:#ece5dd;display:flex;justify-content:center;align-items:center}
.box{width:100%;max-width:420px;height:90vh;background:#fff;border-radius:12px;display:none;flex-direction:column}
.btn{margin:20px;padding:14px;border:none;border-radius:30px;background:#25d366;color:#fff;font-size:16px}
.top{background:#075e54;color:#fff;padding:14px;font-size:18px}
.users{flex:1;overflow:auto}
.user{padding:14px;border-bottom:1px solid #eee;cursor:pointer}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox" style="display:flex">
  <button class="btn" onclick="googleLogin()">Continue with Google</button>
</div>

<!-- HOME -->
<div class="box" id="homeBox">
  <div class="top">Chats</div>
  <div class="users" id="users"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  doc,setDoc,getDocs,collection
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyA7U96MP2BheQ1ilIUqd2UgycPs8KVC-Gc",
  authDomain: "chatapp-d38d3.firebaseapp.com",
  projectId: "chatapp-d38d3",
  storageBucket: "chatapp-d38d3.firebasestorage.app",
  messagingSenderId: "321814992234",
  appId: "1:321814992234:web:d1d8eb9d63fcafc53ec113"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const provider = new GoogleAuthProvider();
let currentUser=null;

/* ðŸ”¥ GOOGLE LOGIN (POPUP â€“ FINAL FIX) */
window.googleLogin = async ()=>{
  try{
    const res = await signInWithPopup(auth, provider);
    const u = res.user;

    await setDoc(doc(db,"users",u.uid),{
      uid:u.uid,
      name:u.displayName || "User",
      email:u.email || ""
    },{merge:true});

  }catch(e){
    alert(e.message);
  }
};

/* AUTH STATE */
onAuthStateChanged(auth, async(user)=>{
  if(user){
    currentUser=user;
    loginBox.style.display="none";
    homeBox.style.display="flex";
    loadUsers();
  }else{
    loginBox.style.display="flex";
    homeBox.style.display="none";
  }
});

/* LOAD USERS */
async function loadUsers(){
  users.innerHTML="";
  const snap = await getDocs(collection(db,"users"));
  snap.forEach(d=>{
    if(d.id!==currentUser.uid){
      const div=document.createElement("div");
      div.className="user";
      div.textContent=d.data().name || d.data().email;
      users.appendChild(div);
    }
  });
}
</script>

</body>
</html>
