<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ChatApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:system-ui,Arial;
  background:#0b1220;
  color:#fff;
}
.hidden{display:none}
.container{max-width:420px;margin:auto;padding:20px}
input,button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  margin-top:10px;
  font-size:16px;
}
button{
  background:#2563eb;
  color:white;
  font-weight:600;
  cursor:pointer;
}
.card{
  background:#111827;
  padding:15px;
  border-radius:16px;
  margin-top:15px;
}
.story-circle{
  width:60px;height:60px;border-radius:50%;
  border:3px solid orange;
  display:flex;align-items:center;justify-content:center;
  margin-right:10px;
}
.bottom-bar{
  position:fixed;bottom:0;left:0;right:0;
  background:#020617;
  display:flex;justify-content:space-around;
  padding:10px 0;
}
.bottom-bar button{
  background:none;color:white;font-size:18px;
}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="container">
  <h2>ChatApp Login</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login / Signup</button>
</div>

<!-- HOME PAGE -->
<div id="homePage" class="container hidden">

  <div class="card">
    <h3>Stories</h3>
    <input type="file" id="storyFile">
    <button onclick="uploadStory()">Add Story</button>
    <div id="stories" style="display:flex;margin-top:10px"></div>
  </div>

  <div class="card">
    <input id="postText" placeholder="What's on your mind?">
    <input type="file" id="postFile">
    <button onclick="addPost()">Post</button>
  </div>

  <div class="card">
    <h3>Feed</h3>
    <div id="feed"></div>
  </div>

</div>

<div class="bottom-bar hidden" id="bottomBar">
  <button onclick="logout()">ðŸ‘¤ Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA7U96MP2BheQ1ilIUqd2UgycPs8KVC-Gc",
  authDomain: "chatapp-d38d3.firebaseapp.com",
  projectId: "chatapp-d38d3",
  storageBucket: "chatapp-d38d3.appspot.com",
  messagingSenderId: "321814992234",
  appId: "1:321814992234:web:d1d8eb9d63fcafc53ec113"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// AUTO LOGIN
onAuthStateChanged(auth, user=>{
  if(user){
    loginPage.classList.add("hidden");
    homePage.classList.remove("hidden");
    bottomBar.classList.remove("hidden");
    loadFeed();
    loadStories();
  }else{
    loginPage.classList.remove("hidden");
    homePage.classList.add("hidden");
    bottomBar.classList.add("hidden");
  }
});

// LOGIN / SIGNUP
window.login = async ()=>{
  try{
    await signInWithEmailAndPassword(auth,email.value,password.value);
  }catch(e){
    if(e.code==="auth/user-not-found"){
      await createUserWithEmailAndPassword(auth,email.value,password.value);
    }else{
      alert(e.message);
    }
  }
};

// LOGOUT
window.logout = ()=>{
  signOut(auth);
};

// POST
window.addPost = async ()=>{
  let img="";
  if(postFile.files[0]){
    const r=ref(storage,"posts/"+Date.now());
    await uploadBytes(r,postFile.files[0]);
    img=await getDownloadURL(r);
  }
  await addDoc(collection(db,"posts"),{
    text:postText.value,
    img,
    time:Date.now()
  });
  postText.value="";
  postFile.value="";
};

// FEED
function loadFeed(){
  const q=query(collection(db,"posts"),orderBy("time","desc"));
  onSnapshot(q,snap=>{
    feed.innerHTML="";
    snap.forEach(d=>{
      const p=d.data();
      feed.innerHTML+=`
        <div class="card">
          <p>${p.text||""}</p>
          ${p.img?`<img src="${p.img}" style="width:100%;border-radius:12px">`:""}
        </div>`;
    });
  });
}

// STORY
window.uploadStory = async ()=>{
  const f=storyFile.files[0];
  if(!f) return;
  const r=ref(storage,"stories/"+Date.now());
  await uploadBytes(r,f);
  const url=await getDownloadURL(r);
  await addDoc(collection(db,"stories"),{url,time:Date.now()});
};

function loadStories(){
  onSnapshot(collection(db,"stories"),snap=>{
    stories.innerHTML="";
    snap.forEach(d=>{
      stories.innerHTML+=`
        <div class="story-circle">
          <img src="${d.data().url}" style="width:100%;height:100%;border-radius:50%">
        </div>`;
    });
  });
}
</script>
</body>
</html>
