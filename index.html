<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatApp</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{height:100vh;background:#ece5dd;display:flex;align-items:center;justify-content:center}

.card,.home,.chat{
  width:100%;max-width:420px;height:90vh;
  background:#fff;border-radius:12px;
  display:none;flex-direction:column
}

.card{display:flex;align-items:center;justify-content:center;padding:20px}
.btn{
  padding:14px;border:none;border-radius:30px;
  background:#25d366;color:#fff;width:100%;font-size:16px
}

.top{background:#075e54;color:#fff;padding:14px;font-size:18px}
.users{flex:1;overflow:auto}
.user{padding:14px;border-bottom:1px solid #eee;cursor:pointer}

.messages{flex:1;padding:10px;overflow:auto;background:#efeae2}
.msg{max-width:70%;padding:10px;border-radius:10px;margin-bottom:8px}
.me{background:#dcf8c6;margin-left:auto}
.other{background:#fff}

.send{display:flex;padding:10px;gap:8px}
.send input{flex:1;padding:10px}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginBox">
  <button class="btn" onclick="googleLogin()">Continue with Google</button>
</div>

<!-- HOME -->
<div class="home" id="homeBox">
  <div class="top">Chats</div>
  <div class="users" id="users"></div>
</div>

<!-- CHAT -->
<div class="chat" id="chatBox">
  <div class="top">
    <button onclick="backHome()">â¬…</button>
    <span id="chatTitle"></span>
  </div>
  <div class="messages" id="messages"></div>
  <div class="send">
    <input id="msg" placeholder="Message">
    <button class="btn" onclick="sendMsg()">Send</button>
  </div>
</div>

<script type="module">
/* ================= FIREBASE IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithRedirect,
  getRedirectResult,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  doc,setDoc,getDocs,addDoc,
  collection,query,orderBy,onSnapshot
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA7U96MP2BheQ1ilIUqd2UgycPs8KVC-Gc",
  authDomain: "chatapp-d38d3.firebaseapp.com",
  projectId: "chatapp-d38d3",
  storageBucket: "chatapp-d38d3.firebasestorage.app",
  messagingSenderId: "321814992234",
  appId: "1:321814992234:web:d1d8eb9d63fcafc53ec113"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= GLOBAL ================= */
let currentUser=null;
let currentChatUser=null;
let unsub=null;

/* ================= GOOGLE LOGIN ================= */
const provider = new GoogleAuthProvider();
window.googleLogin = ()=> signInWithRedirect(auth,provider);

/* ðŸ”¥ VERY IMPORTANT â€“ REDIRECT RESULT (FIX) */
getRedirectResult(auth)
.then(async(res)=>{
  if(res && res.user){
    const u=res.user;
    await setDoc(doc(db,"users",u.uid),{
      uid:u.uid,
      name:u.displayName||"User",
      email:u.email||"",
      photo:u.photoURL||""
    },{merge:true});
  }
}).catch(()=>{});

/* ================= AUTH STATE ================= */
onAuthStateChanged(auth,(user)=>{
  if(user){
    currentUser=user;
    loginBox.style.display="none";
    homeBox.style.display="flex";
    chatBox.style.display="none";
    setTimeout(loadUsers,500);
  }else{
    loginBox.style.display="flex";
    homeBox.style.display="none";
    chatBox.style.display="none";
  }
});

/* ================= USERS ================= */
async function loadUsers(){
  users.innerHTML="";
  const snap=await getDocs(collection(db,"users"));
  let found=false;

  snap.forEach(d=>{
    if(d.id!==currentUser.uid){
      found=true;
      const u=d.data();
      const div=document.createElement("div");
      div.className="user";
      div.textContent=u.name||u.email;
      div.onclick=()=>openChat(d.id,u.name||u.email);
      users.appendChild(div);
    }
  });

  if(!found){
    users.innerHTML="<p style='padding:20px;color:#777'>No other users yet</p>";
  }
}

/* ================= CHAT ================= */
function chatId(a,b){return[a,b].sort().join("_");}

function openChat(uid,name){
  currentChatUser=uid;
  homeBox.style.display="none";
  chatBox.style.display="flex";
  chatTitle.textContent=name;
  messages.innerHTML="";
  if(unsub)unsub();

  const q=query(
    collection(db,"chats",chatId(currentUser.uid,uid),"messages"),
    orderBy("time")
  );

  unsub=onSnapshot(q,snap=>{
    messages.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.from===currentUser.uid?"me":"other");
      div.textContent=m.text;
      messages.appendChild(div);
    });
  });
}

window.sendMsg=async()=>{
  if(!msg.value.trim())return;
  await addDoc(
    collection(db,"chats",chatId(currentUser.uid,currentChatUser),"messages"),
    {text:msg.value,from:currentUser.uid,time:Date.now()}
  );
  msg.value="";
};

window.backHome=()=>{
  chatBox.style.display="none";
  homeBox.style.display="flex";
};
</script>
</body>
</html>
