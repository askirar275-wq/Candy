<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ChatApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:system-ui, Arial;
  background:#0b0f1a;
  color:#fff;
  padding-bottom:80px;
}
.container{max-width:430px;margin:auto;padding:12px}
.card{
  background:#12182b;
  border-radius:16px;
  padding:14px;
  margin:12px 0;
  border:1px solid rgba(255,255,255,.12)
}
input,textarea,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.2);
  background:none;
  color:#fff
}
button:active{transform:scale(.95)}

.story-bar{display:flex;gap:14px;overflow-x:auto}
.story{text-align:center;min-width:70px}
.circle{
  width:64px;height:64px;border-radius:50%;
  padding:3px;
  background:linear-gradient(45deg,#ff2d55,#ff9500,#ffcc00)
}
.inner{
  width:100%;height:100%;
  border-radius:50%;
  background:#1b2238;
  display:flex;align-items:center;justify-content:center;
  font-weight:bold
}

.post{
  background:#1b2238;
  border-radius:14px;
  padding:12px;
  margin:10px 0
}

.bottom-bar{
  position:fixed;bottom:0;left:0;right:0;height:64px;
  background:#0b0f1a;
  display:flex;justify-content:space-around;align-items:center;
  border-top:1px solid rgba(255,255,255,.15)
}
.tab{
  background:none;border:none;
  color:#aaa;font-size:24px
}
.tab.active{color:#4f8cff}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div class="card" id="loginBox">
  <h3>Login / Signup</h3>
  <input id="username" placeholder="Username (signup only)">
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="signup()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

<!-- HOME -->
<div id="home">

<!-- STORIES -->
<div class="card">
  <h4>Stories</h4>

  <!-- ADD STORY -->
  <div style="display:flex;gap:10px">
    <input id="storyText" placeholder="Add your story..." />
    <button onclick="addStory()">+</button>
  </div>

  <div class="story-bar" id="stories"></div>
</div>

<!-- POST -->
<div class="card">
  <textarea id="postText" placeholder="What's on your mind?"></textarea>
  <button onclick="addPost()">Post</button>
</div>

<!-- FEED -->
<div class="card">
  <h4>Feed</h4>
  <div id="feed"></div>
</div>

</div>

<!-- PROFILE -->
<div id="profile" style="display:none" class="card">
  <h3>My Profile</h3>
  <button onclick="logout()">Logout</button>
</div>

</div>
</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar">
  <button class="tab active" onclick="showTab('home',this)">üè†</button>
  <button class="tab" onclick="showTab('profile',this)">üë§</button>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyA7U96MP2BheQ1ilIUqd2UgycPs8KVC-Gc",
  authDomain:"chatapp-d38d3.firebaseapp.com",
  projectId:"chatapp-d38d3"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

/* ONE-TIME LOGIN */
auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.style.display="none";
    app.style.display="block";
    loadStories();
    loadFeed();
  }else{
    loginBox.style.display="block";
    app.style.display="none";
  }
});

/* AUTH */
function signup(){
  if(!username.value) return alert("Enter username");
  auth.createUserWithEmailAndPassword(email.value,password.value)
    .then(c=>{
      db.collection("users").doc(c.user.uid).set({
        username:username.value
      });
    }).catch(e=>alert(e.message));
}
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
    .catch(e=>alert(e.message));
}
function logout(){auth.signOut()}

/* TABS */
function showTab(tab,btn){
  home.style.display="none";
  profile.style.display="none";
  document.getElementById(tab).style.display="block";
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

/* STORIES */
function addStory(){
  if(!storyText.value.trim()) return;
  db.collection("stories").add({
    text:storyText.value,
    uid:auth.currentUser.uid,
    hiddenFrom:{},
    viewers:{},
    time:firebase.firestore.FieldValue.serverTimestamp()
  });
  storyText.value="";
}

function loadStories(){
  const DAY=24*60*60*1000;
  const now=Date.now();

  db.collection("stories").orderBy("time","desc")
  .onSnapshot(snap=>{
    stories.innerHTML="";
    snap.forEach(d=>{
      const s=d.data();
      if(!s.time) return;
      if(now - s.time.toMillis() > DAY) return;
      if(s.hiddenFrom && s.hiddenFrom[auth.currentUser.uid]) return;

      const div=document.createElement("div");
      div.className="story";
      div.innerHTML=`
        <div class="circle">
          <div class="inner">${s.text[0]}</div>
        </div>
      `;
      stories.appendChild(div);
    });
    if(!stories.innerHTML){
      stories.innerHTML="<small style='opacity:.6'>No stories yet</small>";
    }
  });
}

/* POSTS */
function addPost(){
  if(!postText.value.trim()) return;
  db.collection("posts").add({
    text:postText.value,
    uid:auth.currentUser.uid,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });
  postText.value="";
}
function loadFeed(){
  db.collection("posts").orderBy("time","desc")
  .onSnapshot(s=>{
    feed.innerHTML="";
    s.forEach(d=>{
      const p=d.data();
      const div=document.createElement("div");
      div.className="post";
      div.innerText=p.text;
      feed.appendChild(div);
    });
    if(!feed.innerHTML){
      feed.innerHTML="<small style='opacity:.6'>No posts yet</small>";
    }
  });
}
</script>
</body>
</html>
