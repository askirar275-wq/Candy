<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Candy Pop ‚Äî Cartoon Pull-ready</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üç≠</text></svg>">
<style>
  :root{
    --cols:8; --rows:8; --gap:6px; --tile:64px;
    --accent1:#ff6bd6; --accent2:#ffcf6b;
    --bg1:#fff9fb; --bg2:#f2f8ff;
    --card-radius:18px;
    --pop-dur:260ms; --fall-dur:300ms;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#222;-webkit-font-smoothing:antialiased}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
  .app{width:100%;max-width:980px;background:linear-gradient(180deg,#fff,#fffbff);border-radius:var(--card-radius);padding:14px;box-shadow:0 24px 80px rgba(20,20,50,.08);display:flex;gap:12px;flex-direction:column}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,#fff0f6,#ffeef8);display:flex;align-items:center;justify-content:center;font-size:34px}
  .actions{display:flex;gap:8px;align-items:center}
  .btn{padding:10px 14px;border-radius:12px;border:0;background:#fff;font-weight:800;cursor:pointer;box-shadow:0 10px 28px rgba(20,20,60,0.06)}
  .btn.primary{background:linear-gradient(90deg,var(--accent1),#ff9ac8);color:#fff}
  .layout{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
  .left{flex:1 1 640px;min-width:320px}
  .right{width:300px;min-width:220px}
  .hud{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{background:linear-gradient(180deg,#fff,#fff7fb);padding:8px 12px;border-radius:999px;font-weight:800;box-shadow:0 8px 22px rgba(20,20,60,0.04)}
  .board-area{padding:10px;border-radius:16px;background:linear-gradient(180deg,#fff7ff,#fff);box-shadow:inset 0 8px 30px rgba(250,240,250,0.4);display:flex;align-items:center;justify-content:center}
  .grid{display:grid;gap:var(--gap);grid-template-columns:repeat(var(--cols),var(--tile));grid-auto-rows:var(--tile);place-items:center;touch-action:none;user-select:none}
  .cell{width:var(--tile);height:var(--tile);border-radius:14px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#fff,#fffefc);box-shadow:0 8px 18px rgba(10,10,30,0.05);cursor:grab;position:relative;border:1px solid rgba(0,0,0,0.04);overflow:visible;padding:0}
  .cell img{width:84%;height:84%;object-fit:contain;pointer-events:none;display:block}
  .cell.pop{animation:pop var(--pop-dur) cubic-bezier(.2,.9,.2,1) forwards}
  @keyframes pop{0%{transform:scale(1);opacity:1}50%{transform:scale(1.45)}100%{transform:scale(0);opacity:0}}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:10px}
  .right-panel{display:flex;flex-direction:column;gap:10px}
  .card-box{background:linear-gradient(180deg,#fff,#fff7fb);padding:12px;border-radius:12px;box-shadow:0 10px 28px rgba(20,20,60,0.04)}
  .modal-bg{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(10,8,18,0.36);display:none;align-items:center;justify-content:center;z-index:999}
  .modal{width:94%;max-width:720px;background:#fff;border-radius:14px;padding:14px;box-shadow:0 30px 80px rgba(10,10,30,0.25);max-height:86vh;overflow:auto}
  @media(max-width:760px){:root{--tile:52px;--gap:4px}.right{width:100%}}
  .footer{display:flex;justify-content:space-between;align-items:center;padding-top:8px}
  .note{font-size:13px;color:#666}
</style>
</head>
<body>
  <div class="wrap">
    <div class="app" id="app">
      <div class="topbar">
        <div class="brand">
          <div class="logo">üç≠</div>
          <div>
            <div style="font-weight:900;font-size:18px">Candy Pop ‚Äî Cartoon (Pull-ready)</div>
            <div style="font-size:12px;color:#666">Drop this index.html + images/ to your repo</div>
          </div>
        </div>

        <div class="actions">
          <button id="homeBtn" class="btn">Home</button>
          <button id="shopBtn" class="btn">Shop</button>
          <button id="muteBtn" class="btn">üîä</button>
          <button id="startBtn" class="btn primary">Start</button>
        </div>
      </div>

      <div class="layout">
        <div class="left">
          <div class="hud">
            <div class="pill">Score <div id="score" style="font-size:15px">0</div></div>
            <div class="pill">Moves <div id="moves" style="font-size:15px">40</div></div>
            <div class="pill">Level <div id="level" style="font-size:15px">1</div></div>
            <div style="margin-left:auto" class="pill">Coins <div id="coins" style="font-size:15px">0</div></div>
          </div>

          <div style="height:12px"></div>

          <div class="board-area">
            <div id="grid" class="grid" role="grid" aria-label="Game grid"></div>
          </div>

          <div class="controls">
            <button id="restart" class="btn primary">Restart</button>
            <button id="shuffle" class="btn">Shuffle</button>
            <button id="placeBomb" class="btn">Place Bomb</button>
            <select id="themeSelect" class="btn" style="padding:8px;border-radius:8px">
              <option value="candy">Theme: Candy</option>
              <option value="fruit">Theme: Fruit</option>
            </select>
          </div>
        </div>

        <div class="right">
          <div class="card-box">
            <div style="font-weight:900">Level Progress</div>
            <div id="levelTarget" class="note">Target: 1000</div>
            <div style="height:10px"></div>
            <div class="note">Power-ups & Shop</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="buyBomb" class="btn">Buy Bomb (200)</button>
              <button id="buyShuffle" class="btn">Buy Shuffle (100)</button>
            </div>
          </div>

          <div class="card-box">
            <div style="font-weight:900">Inventory</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <div class="note">Bombs: <span id="invBomb">0</span></div>
              <div class="note">Shuffle: <span id="invShuffle">0</span></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="useInvBomb" class="btn">Use Bomb</button>
              <button id="useInvShuffle" class="btn">Use Shuffle</button>
            </div>
          </div>

          <div class="card-box">
            <div style="font-weight:900">Save / Load</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveBtn" class="btn">Save</button>
              <button id="loadBtn" class="btn">Load</button>
            </div>
          </div>

        </div>
      </div>

      <div class="footer">
        <div class="note">Images loaded from <span id="imgCount">0</span> files</div>
        <div class="note">Cartoon style ‚Äî single page</div>
      </div>
    </div>
  </div>

  <!-- SHOP / MODAL -->
  <div id="modalBg" class="modal-bg" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Shop</h3>
      <div id="modalBody"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="closeModal" class="btn">Close</button>
      </div>
    </div>
  </div>

<script>
/* ---------------------------- CONFIG ---------------------------- */
const COLS = 8, ROWS = 8, SIZE = COLS * ROWS;
const IMAGE_BASE = 'images/';
const THEMES = {
  candy: ['candy1.png','candy2.png','candy3.png','candy4.png','candy5.png','candy6.png','candy7.png','candy8.png','candy9.png','candy10.png'],
  fruit: ['fruit1.png','fruit2.png','fruit3.png','fruit4.png','fruit5.png','fruit6.png','fruit7.png','fruit8.png','fruit9.png','fruit10.png']
};
const BOMB_IMG = 'bomb.png';

/* ---------------------------- STATE ---------------------------- */
let pool = []; // populated with actual URLs
let state = {
  nextId:1,
  board:new Array(SIZE).fill(null),
  score:0,
  moves:40,
  level:1,
  coins:300,
  inv:{bomb:0,shuffle:0},
  levelTarget:1000
};
let CELL = [];
let dragging=false, pointerId=null, startIndex=null, locked=false, muted=false;

/* ---------------------------- DOM ---------------------------- */
const gridEl = document.getElementById('grid'),
      scoreEl = document.getElementById('score'),
      movesEl = document.getElementById('moves'),
      levelEl = document.getElementById('level'),
      coinsEl = document.getElementById('coins'),
      imgCountEl = document.getElementById('imgCount'),
      invBombEl = document.getElementById('invBomb'),
      invShuffleEl = document.getElementById('invShuffle'),
      levelTargetEl = document.getElementById('levelTarget'),
      modalBg = document.getElementById('modalBg'),
      modalTitle = document.getElementById('modalTitle'),
      modalBody = document.getElementById('modalBody'),
      closeModalBtn = document.getElementById('closeModal');

/* ---------------------------- SOUND ---------------------------- */
const audioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
function playBeep(freq=440, t=0.06, type='sine', gain=0.08){
  if(!audioCtx || muted) return;
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + t);
  }catch(e){}
}

/* ---------------------------- IMAGE LOADER ---------------------------- */
function tryLoad(url){ return new Promise(res => { const i=new Image(); i.onload = ()=>res({ok:true,url}); i.onerror = ()=>res({ok:false,url}); i.src = url; }); }
async function loadTheme(theme='candy'){
  const list = THEMES[theme] || THEMES.candy;
  const results = await Promise.all(list.map(n => tryLoad(IMAGE_BASE + n)));
  pool = results.filter(r=>r.ok).map(r=>r.url);
  if(pool.length === 0){
    // fallback simple SVG placeholders (data URIs)
    pool = list.slice(0,6).map((_,i)=>`data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect width='100%' height='100%' fill='%23f6f6f6' /><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='80'>üç≠</text></svg>`);
  }
  tryLoad(IMAGE_BASE + BOMB_IMG).then(r => pool.bomb = r.ok ? r.url : null);
  imgCountEl.textContent = pool.length;
  return pool;
}

/* ---------------------------- GRID (static cells) ---------------------------- */
function createGrid(){
  gridEl.innerHTML = '';
  CELL = [];
  for(let i=0;i<SIZE;i++){
    const btn = document.createElement('button');
    btn.className = 'cell';
    btn.dataset.index = i;
    const img = document.createElement('img');
    img.alt = 'tile';
    img.draggable = false;
    btn.appendChild(img);
    btn.addEventListener('pointerdown', onDown);
    gridEl.appendChild(btn);
    CELL.push({btn,img});
  }
}

/* ---------------------------- TILE HELPERS ---------------------------- */
function makeTile(src){
  return { id: state.nextId++, src: src || pool[Math.floor(Math.random()*pool.length)], power:null };
}
function randTile(){ return makeTile(); }

/* ---------------------------- RENDER (no random in render) ---------------------------- */
function render(dropMap){
  for(let i=0;i<SIZE;i++){
    const tile = state.board[i];
    const {btn,img} = CELL[i];
    // remove stray text nodes
    btn.childNodes.forEach(n=>{ if(n.nodeType===3) n.remove(); });
    if(tile){
      if(img.dataset.src !== tile.src){
        img.dataset.src = tile.src;
        img.src = tile.src;
      }
      btn.style.visibility = 'visible';
    } else {
      img.dataset.src = '';
      img.src = '';
      btn.style.visibility = 'hidden';
    }
    btn.style.transition = '';
    btn.style.transform = '';
    if(dropMap && tile && dropMap[tile.id]){
      btn.style.transform = `translateY(${dropMap[tile.id]})`;
      requestAnimationFrame(()=> requestAnimationFrame(()=> {
        btn.style.transition = `transform var(--fall-dur) cubic-bezier(.2,.8,.2,1)`;
        btn.style.transform = 'translateY(0)';
      }));
    }
    btn.classList.remove('pop');
  }
  updateHUD();
}

/* ---------------------------- MATCH DETECTION ---------------------------- */
function findMatches(bd){
  const matches = [];
  // horizontal
  for(let r=0;r<ROWS;r++){
    let run=[r*COLS];
    for(let c=1;c<COLS;c++){
      const p=r*COLS+c-1,i=r*COLS+c;
      if(bd[i] && bd[p] && bd[i].src === bd[p].src) run.push(i);
      else { if(run.length>=3) matches.push([...run]); run=[i]; }
    }
    if(run.length>=3) matches.push([...run]);
  }
  // vertical
  for(let c=0;c<COLS;c++){
    let run=[c];
    for(let r=1;r<ROWS;r++){
      const p=(r-1)*COLS+c,i=r*COLS+c;
      if(bd[i] && bd[p] && bd[i].src === bd[p].src) run.push(i);
      else { if(run.length>=3) matches.push([...run]); run=[i]; }
    }
    if(run.length>=3) matches.push([...run]);
  }
  return matches;
}

/* ---------------------------- SPECIALS (simple) ---------------------------- */
function detectSpecials(matches){
  const assign = {};
  matches.forEach(run=>{
    if(run.length >= 5){ const idx = run[Math.floor(run.length/2)]; assign[idx] = {type:'bomb'}; }
    else if(run.length === 4){ const idx = run[Math.floor(run.length/2)]; assign[idx] = {type:'bomb'}; }
  });
  return assign;
}

/* ---------------------------- POP, GRAVITY, REFILL ---------------------------- */
function burst(cx,cy,amt=8){
  amt = Math.min(12, amt);
  const rect = gridEl.getBoundingClientRect();
  const ox = cx - rect.left, oy = cy - rect.top;
  for(let i=0;i<amt;i++){
    const p = document.createElement('div');
    p.style.position='absolute'; p.style.left = ox+'px'; p.style.top = oy+'px';
    const s = 6 + Math.random()*10; p.style.width=p.style.height = s+'px';
    p.style.borderRadius='50%'; p.style.background = `rgba(255,90,140,${0.35+Math.random()*0.5})`; p.style.pointerEvents='none';
    gridEl.parentElement.appendChild(p);
    const a = Math.random()*Math.PI*2, d = 18 + Math.random()*60;
    const nx = Math.cos(a)*d, ny = Math.sin(a)*d;
    p.animate([{transform:'translate(-50%,-50%) scale(1)',opacity:1},{transform:`translate(-50%,-50%) translate(${nx}px,${ny}px) scale(.3)`,opacity:0}],{duration:420+Math.random()*260,easing:'cubic-bezier(.2,.8,.2,1)'});
    setTimeout(()=>p.remove(),1000);
  }
}

function resolveChain(){
  if(locked) return;
  locked = true;
  state.combo = 1;
  (function step(){
    const matches = findMatches(state.board);
    if(matches.length === 0){ locked=false; updateHUD(); return; }
    const specialMap = detectSpecials(matches);
    const removedSet = new Set();
    matches.forEach(run=> run.forEach(i => removedSet.add(i)));
    const removedIdx = Array.from(removedSet).sort((a,b)=>a-b);
    const removedCount = removedIdx.length;
    state.score += removedCount * 12 * state.combo; state.combo++;
    playBeep(880,0.06,'triangle',0.06);
    updateHUD();

    // animate pop + nullify
    let cx=0, cy=0, cnt=0;
    removedIdx.forEach(i=>{
      const el = CELL[i].btn;
      if(el){ const rc = el.getBoundingClientRect(); cx += rc.left + rc.width/2; cy += rc.top + rc.height/2; cnt++; el.classList.add('pop'); }
      state.board[i] = null;
    });
    if(cnt>0) burst(cx/cnt, cy/cnt, Math.min(16, 4+cnt));

    // gravity + refill (new tiles only here)
    setTimeout(()=>{
      try{
        const cols = [];
        for(let c=0;c<COLS;c++){
          const col = [];
          for(let r=ROWS-1;r>=0;r--){
            const idx = r*COLS + c;
            if(state.board[idx]) col.push(state.board[idx]);
          }
          cols.push(col);
        }
        const newBoard = new Array(SIZE).fill(null);
        const dropMap = {};
        const tilePx = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tile')) || 64;
        const oldIds = new Set(state.board.filter(Boolean).map(t=>t.id));
        for(let c=0;c<COLS;c++){
          const col = cols[c];
          while(col.length < ROWS) col.push(makeTile()); // new tiles here only
          for(let r=ROWS-1,i=0;r>=0;r--,i++){
            const tile = col[i];
            newBoard[r*COLS + c] = tile;
            if(!oldIds.has(tile.id)) dropMap[tile.id] = `-${(i+1)*tilePx}px`;
          }
        }
        // apply special markers (bomb image) if any
        Object.keys(specialMap).forEach(k=>{
          const idx = Number(k);
          if(newBoard[idx]) newBoard[idx].src = (pool.bomb || (IMAGE_BASE + BOMB_IMG));
          else { const pos = newBoard.findIndex(x=>x); if(pos>=0) newBoard[pos].src = (pool.bomb || (IMAGE_BASE + BOMB_IMG)); }
        });
        state.board = newBoard;
        fitTiles(); render(dropMap);
      }catch(e){ console.error('gravity/refill err', e); }
      setTimeout(()=> setTimeout(step, 220), 320);
    }, 300);
  })();
}

/* ---------------------------- INPUT: drag swap ---------------------------- */
function onDown(e){
  if(locked) return;
  const el = e.currentTarget;
  el.setPointerCapture && el.setPointerCapture(e.pointerId);
  dragging = true; pointerId = e.pointerId; startIndex = Number(el.dataset.index);
  document.addEventListener('pointermove', onMove);
  document.addEventListener('pointerup', onUp);
}
function onMove(e){
  if(!dragging || e.pointerId !== pointerId) return;
  const target = document.elementFromPoint(e.clientX, e.clientY);
  if(!target) return;
  const cell = target.closest && target.closest('.cell') ? target.closest('.cell') : null;
  if(!cell) return;
  const idx = Number(cell.dataset.index);
  if(Number.isNaN(idx)) return;
  if(isAdjacent(startIndex, idx) && idx !== startIndex){
    swapTiles(startIndex, idx);
    render();
    state.moves = Math.max(0, state.moves-1);
    updateHUD();
    const matches = findMatches(state.board);
    if(matches.length > 0){ resolveChain(); playBeep(660,0.05,'sine',0.05); }
    else setTimeout(()=>{ swapTiles(startIndex, idx); render(); }, 260);
    startIndex = idx;
  }
}
function onUp(e){
  dragging=false; pointerId=null; startIndex=null;
  document.removeEventListener('pointermove', onMove);
  document.removeEventListener('pointerup', onUp);
}
function isAdjacent(a,b){ if(a==null||b==null) return false; const r1=Math.floor(a/COLS),c1=a%COLS,r2=Math.floor(b/COLS),c2=b%COLS; return Math.abs(r1-r2)+Math.abs(c1-c2)===1; }
function swapTiles(i,j){ [state.board[i], state.board[j]] = [state.board[j], state.board[i]]; }

/* ---------------------------- UI CONTROLS ---------------------------- */
document.getElementById('startBtn').addEventListener('click', ()=> { openModal(false); render(); });
document.getElementById('shopBtn').addEventListener('click', ()=> openModal(true,'shop'));
document.getElementById('homeBtn').addEventListener('click', ()=> openModal(true,'home'));
document.getElementById('muteBtn').addEventListener('click', ()=> { muted = !muted; document.getElementById('muteBtn').textContent = muted ? 'üîà' : 'üîä'; });
document.getElementById('restart').addEventListener('click', ()=> init(true));
document.getElementById('shuffle').addEventListener('click', ()=>{
  const arr = state.board.slice();
  for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  state.board = arr; render(); playBeep(520,0.06,'sine',0.06);
});
document.getElementById('placeBomb').addEventListener('click', ()=>{
  if(locked) return;
  const valid = state.board.map((t,i)=> t ? i : -1).filter(i=>i>=0);
  if(valid.length===0) return;
  const idx = valid[Math.floor(Math.random()*valid.length)];
  state.board[idx] = makeTile(pool.bomb || (IMAGE_BASE + BOMB_IMG)); state.board[idx].power = {type:'bomb'};
  render();
  setTimeout(()=>{ const rem=new Set(); const r0=Math.floor(idx/COLS), c0=idx%COLS; for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ const nr=r0+dr,nc=c0+dc; if(nr>=0&&nr<ROWS&&nc>=0&&nc<COLS) rem.add(nr*COLS+nc);} Array.from(rem).forEach(i=>{ CELL[i].btn.classList.add('pop'); state.board[i]=null;}); state.score += rem.size * 12; updateHUD(); setTimeout(()=> resolveChain(),260); },240);
});
document.getElementById('themeSelect').addEventListener('change', async (e)=>{ await loadTheme(e.target.value); init(true); });

/* shop / inventory */
document.getElementById('buyBomb').addEventListener('click', ()=> buyItem('bomb',200));
document.getElementById('buyShuffle').addEventListener('click', ()=> buyItem('shuffle',100));
document.getElementById('useInvBomb').addEventListener('click', ()=> useInv('bomb'));
document.getElementById('useInvShuffle').addEventListener('click', ()=> useInv('shuffle'));
document.getElementById('saveBtn').addEventListener('click', saveProgress);
document.getElementById('loadBtn').addEventListener('click', loadProgress);
closeModalBtn.addEventListener('click', ()=> openModal(false));

function buyItem(id, price){
  if(state.coins < price){ openModal(true,'<p>Not enough coins.</p>'); return; }
  state.coins -= price; state.inv[id] = (state.inv[id]||0) + 1; updateHUD(); playBeep(880,0.06,'sine',0.06);
}
function useInv(id){
  if((state.inv[id]||0) <= 0){ openModal(true,'<p>Inventory empty.</p>'); return; }
  state.inv[id]--;
  if(id==='bomb'){ const valid = state.board.map((t,i)=> t ? i : -1).filter(i=>i>=0); if(valid.length===0) return; const idx = valid[Math.floor(Math.random()*valid.length)]; state.board[idx]=makeTile(pool.bomb || (IMAGE_BASE + BOMB_IMG)); state.board[idx].power={type:'bomb'}; render(); setTimeout(()=>{ const rem=new Set(); const r0=Math.floor(idx/COLS), c0=idx%COLS; for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ const nr=r0+dr,nc=c0+dc; if(nr>=0&&nr<ROWS&&nc>=0&&nc<COLS) rem.add(nr*COLS+nc);} Array.from(rem).forEach(i=>{ CELL[i].btn.classList.add('pop'); state.board[i]=null;}); state.score += rem.size * 12; updateHUD(); setTimeout(()=> resolveChain(),260); },220); }
  else if(id==='shuffle'){ const arr = state.board.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } state.board = arr; render(); }
  updateHUD();
}

/* ---------------------------- SAVE / LOAD ---------------------------- */
function saveProgress(){
  const s = { score: state.score, coins: state.coins, inv: state.inv, level: state.level, levelTarget: state.levelTarget, board: state.board.map(t=> t ? {id:t.id,src:t.src,power:t.power} : null), nextId: state.nextId };
  localStorage.setItem('candy_cartoon_save', JSON.stringify(s));
  openModal(true,'<p>Saved to localStorage.</p>');
}
function loadProgress(){
  const raw = localStorage.getItem('candy_cartoon_save');
  if(!raw){ openModal(true,'<p>No save found.</p>'); return; }
  try{
    const s = JSON.parse(raw);
    state.score = s.score || 0; state.coins = s.coins || 0; state.inv = s.inv || {bomb:0,shuffle:0};
    state.level = s.level || 1; state.levelTarget = s.levelTarget || 1000; state.nextId = s.nextId || 1;
    state.board = (s.board || []).map(x => x ? {id:x.id, src:x.src, power:x.power} : null);
    if(state.board.length !== SIZE) fillInitialBoard();
    render(); updateHUD(); openModal(true,'<p>Loaded.</p>');
  }catch(e){ openModal(true,'<p>Failed to load.</p>'); }
}

/* ---------------------------- MODAL ---------------------------- */
function openModal(show, typeOrHtml){
  if(!show){ modalBg.style.display = 'none'; modalBg.setAttribute('aria-hidden','true'); return; }
  modalBg.style.display = 'flex'; modalBg.setAttribute('aria-hidden','false');
  if(typeOrHtml === 'shop'){
    modalTitle.textContent = 'Shop';
    modalBody.innerHTML = `<p>Buy power-ups with coins.</p><ul><li>Bomb ‚Äî 200</li><li>Shuffle ‚Äî 100</li></ul>`;
  } else if(typeOrHtml === 'home'){
    modalTitle.textContent = 'Home';
    modalBody.innerHTML = `<p>Welcome! Click Start / Restart to play. Use Shop to buy power-ups.</p>`;
  } else {
    modalTitle.textContent = 'Info';
    modalBody.innerHTML = String(typeOrHtml || '');
  }
}

/* ---------------------------- HUD & INIT ---------------------------- */
function updateHUD(){
  scoreEl.textContent = state.score;
  movesEl.textContent = state.moves;
  levelEl.textContent = state.level;
  coinsEl.textContent = state.coins;
  invBombEl.textContent = state.inv.bomb || 0;
  invShuffleEl.textContent = state.inv.shuffle || 0;
  levelTargetEl.textContent = `Target: ${state.levelTarget}`;
}

function fitTiles(){
  const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 6;
  const wrap = document.querySelector('.board-area').getBoundingClientRect();
  const availW = Math.min(wrap.width - 16, window.innerWidth - 48);
  const candidateW = Math.floor((availW - gap*(COLS-1))/COLS);
  const desired = Math.max(36, Math.min(candidateW, 90));
  document.documentElement.style.setProperty('--tile', desired + 'px');
}

function fillInitialBoard(){
  state.nextId = 1;
  state.board = new Array(SIZE).fill(null).map(()=>randTile());
  let tries=0;
  while(findMatches(state.board).length > 0 && tries++ < 900){
    state.board = new Array(SIZE).fill(null).map(()=>randTile());
  }
}

/* ---------------------------- BOOT ---------------------------- */
async function init(force=false){
  const theme = document.getElementById('themeSelect')?.value || 'candy';
  await loadTheme(theme);
  if(!CELL.length) createGrid();
  if(force || !state.board || state.board.filter(Boolean).length === 0) fillInitialBoard();
  if(force){ state.score = 0; state.moves = 40; state.level = 1; state.levelTarget = 1000; }
  fitTiles(); render();
  updateHUD();
}
(async function start(){
  await loadTheme('candy');
  createGrid();
  fillInitialBoard();
  updateHUD();
  render();
  window.addEventListener('resize', ()=>{ clearTimeout(window._resizeTO); window._resizeTO = setTimeout(()=>{ fitTiles(); render(); }, 120); });
  // optional service worker registration (if you add service-worker.js in repo root)
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('/service-worker.js').then(()=>console.log('SW registered')).catch(()=>{}); }
})();

/* expose debug */
window._game = { state, render, init, fillInitialBoard };

/* ---------------------------- END ---------------------------- */
</script>
</body>
</html>
