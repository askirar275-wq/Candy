<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Candy Match ‚Äî Smooth & Big</title>
<style>
:root{
  --cols:8;
  --rows:8;
  --gap:4px;        /* smaller gap */
  --tile:64px;      /* overridden by JS */
  --accent:#ff4d9e;
  --pop-dur:300ms;
  --fall-dur:320ms;
  --tile-boost:1.25; /* bigger tiles multiplier */
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,#fff9fc,#f2f7ff);color:#222}
.stage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:12px}
.card{
  width:100%; max-width:980px; height:calc(100vh - 24px); padding:14px; border-radius:14px; background:#fff;
  box-shadow:0 18px 60px rgba(20,20,50,.06); display:flex; flex-direction:column; gap:12px; overflow:hidden;
}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex:0 0 auto}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#fff0f6,#ffeef8);display:flex;align-items:center;justify-content:center;font-size:28px}
.hud{display:flex;gap:14px;align-items:center}
.hud .pill{background:linear-gradient(180deg,#fff,#fff7fb);padding:10px 18px;border-radius:40px;box-shadow:0 8px 22px rgba(20,20,60,0.04);text-align:center;font-weight:800}
.content{display:flex;flex-direction:column;gap:8px;flex:1 1 auto;min-height:0}

/* grid area */
.grid-area{flex:1 1 auto;display:flex;align-items:center;justify-content:center;min-height:0;padding:6px}
.grid-wrap{
  width:100%; max-width:860px; border-radius:12px; background:linear-gradient(180deg,#fff,#fff7fb);
  padding:18px; display:flex;align-items:center;justify-content:center;position:relative;box-shadow:inset 0 6px 18px rgba(250,240,250,0.35);
  max-height: calc(100vh - 24px - 64px - 140px); overflow:hidden;
}

.grid{
  display:grid; gap:var(--gap); grid-template-columns:repeat(var(--cols), var(--tile));
  grid-auto-rows:var(--tile); justify-content:center; align-content:center; touch-action:none; user-select:none;
  transform-origin:center center;
}

.cell{
  width:var(--tile); height:var(--tile); border-radius:14px; display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg,#fff,#fffefc); box-shadow:0 6px 12px rgba(10,10,30,0.04);
  cursor:grab; transition:transform .12s ease, opacity .12s ease; position:relative; border:1px solid rgba(0,0,0,0.03);
  overflow:visible; will-change:transform,opacity;
}
.cell img{ width:86%; height:86%; object-fit:contain; pointer-events:none; display:block; user-select:none; transform:translateZ(0); }
.cell.pop{animation:pop var(--pop-dur) cubic-bezier(.2,.9,.2,1) forwards}
@keyframes pop{0%{transform:scale(1);opacity:1}45%{transform:scale(1.45)}100%{transform:scale(0);opacity:0}}

.controls{flex:0 0 auto;display:flex;gap:12px;align-items:center;justify-content:center;padding:8px 6px;flex-wrap:wrap}
.btn{padding:12px 16px;border-radius:18px;border:0;font-weight:800;background:#fff;cursor:pointer;box-shadow:0 8px 22px rgba(20,20,60,0.06)}
.btn.primary{background:linear-gradient(90deg,var(--accent),#ff9ac8);color:#fff}

.footer{flex:0 0 86px;display:flex;align-items:center;justify-content:space-between;padding:10px 6px;gap:12px}
.progress{height:14px;width:240px;background:#eee;border-radius:999px;overflow:hidden}
.progress i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff9ac8,#ff6aa8);transition:width 320ms ease}

@media(max-width:720px){
  .grid-wrap{max-height:calc(100vh - 24px - 64px - 160px);} :root{ --tile:52px; }
}
</style>
</head>
<body>
  <div class="stage">
    <div class="card" id="card">
      <header>
        <div class="brand">
          <div class="logo">üç≠</div>
          <div>
            <div style="font-weight:900;font-size:18px">Candy Match</div>
            <div class="meta">Smooth ‚Äî bigger candy, tighter grid</div>
          </div>
        </div>
        <div class="hud">
          <div class="pill"><small>Level</small><div id="level">1</div></div>
          <div class="pill"><small>Score</small><div id="score">0</div></div>
          <div class="pill"><small>Moves</small><div id="moves">40</div></div>
        </div>
      </header>

      <div class="content">
        <div class="grid-area">
          <div id="gridWrap" class="grid-wrap">
            <div id="grid" class="grid" role="grid" aria-label="Candy grid"></div>
          </div>
        </div>

        <div class="controls">
          <button id="restart" class="btn primary">Restart</button>
          <button id="shuffle" class="btn">Shuffle</button>
          <button id="useBombBtn" class="btn">Use Bomb</button>
        </div>
      </div>

      <div class="footer">
        <div id="comboText" style="font-weight:900;color:var(--accent)">Combo √ó1</div>
        <div class="progress" aria-hidden><i id="progressBar"></i></div>
      </div>
    </div>
  </div>

<script>
/* Smooth + bigger tiles tweak
   NOTE: images must be in images/ folder:
   candy1.png ... candy10.png  and bomb.jpg
*/

const WIDTH = 8, HEIGHT = 8, SIZE = WIDTH*HEIGHT;
const IMAGE_FILES = [
  'images/candy1.png','images/candy2.png','images/candy3.png','images/candy4.png','images/candy5.png',
  'images/candy6.png','images/candy7.png','images/candy8.png','images/candy9.png','images/candy10.png'
];
const BOMB_FILE = 'images/bomb.jpg';

const grid = document.getElementById('grid');
const gridWrap = document.getElementById('gridWrap');
const scoreEl = document.getElementById('score');
const movesEl = document.getElementById('moves');
const comboText = document.getElementById('comboText');
const progressBar = document.getElementById('progressBar');
const useBombBtn = document.getElementById('useBombBtn');

let state = { board: [], nextId:1, score:0, moves:40, combo:1 };
let locked=false;

/* tile object */
function makeTile(src){ return { id: state.nextId++, src, power:null }; }
function randTile(){ return makeTile(IMAGE_FILES[Math.floor(Math.random()*IMAGE_FILES.length)]); }

/* fit tiles (bigger and still fit) */
function fitTiles(){
  const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 4;
  const cardRect = document.getElementById('card').getBoundingClientRect();
  const headerH = document.querySelector('header').getBoundingClientRect().height;
  const controlsH = document.querySelector('.controls').getBoundingClientRect().height;
  const footerH = document.querySelector('.footer').getBoundingClientRect().height;
  const padTop = parseFloat(getComputedStyle(document.getElementById('card')).paddingTop)||0;
  const padBottom = parseFloat(getComputedStyle(document.getElementById('card')).paddingBottom)||0;
  const availH = cardRect.height - headerH - controlsH - footerH - padTop - padBottom - 8;
  const availW = Math.min(gridWrap.getBoundingClientRect().width - 12, cardRect.width - 40);

  const candidateH = Math.floor((availH - gap*(HEIGHT-1)) / HEIGHT);
  const candidateW = Math.floor((availW - gap*(WIDTH-1)) / WIDTH);
  let base = Math.max(28, Math.min(candidateH, candidateW));
  const boost = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tile-boost')) || 1.18;
  let desired = Math.floor(base * boost);
  const neededW = desired * WIDTH + gap*(WIDTH-1);
  const neededH = desired * HEIGHT + gap*(HEIGHT-1);
  if(neededW > availW || neededH > availH) desired = base;
  if(!isFinite(desired) || desired < 24) desired = 24;
  document.documentElement.style.setProperty('--tile', desired + 'px');
}

/* render */
function render(dropMap){
  for(let i=0;i<SIZE;i++) if(!state.board[i]) state.board[i]=randTile();
  grid.innerHTML='';
  grid.style.setProperty('--cols', WIDTH);
  for(let i=0;i<SIZE;i++){
    const t = state.board[i];
    const el = document.createElement('button');
    el.className='cell';
    el.dataset.index = i;
    if(t){
      const img = document.createElement('img');
      img.src = t.src;
      img.alt = 'candy';
      el.appendChild(img);
    }
    if(dropMap && dropMap[t.id]){
      el.style.transform = `translateY(${dropMap[t.id]})`;
      requestAnimationFrame(()=> requestAnimationFrame(()=>{ el.style.transition = `transform var(--fall-dur) cubic-bezier(.2,.8,.2,1)`; el.style.transform='translateY(0)'; }));
    }
    el.addEventListener('pointerdown', onPointerDown);
    grid.appendChild(el);
  }
  updateHUD();
}

/* find matches */
function findMatches(bd){
  const matches=[];
  for(let r=0;r<HEIGHT;r++){
    let run=[r*WIDTH];
    for(let c=1;c<WIDTH;c++){
      const p=r*WIDTH+c-1,i=r*WIDTH+c;
      if(bd[i] && bd[p] && bd[i].src===bd[p].src) run.push(i);
      else { if(run.length>=3) matches.push([...run]); run=[i]; }
    }
    if(run.length>=3) matches.push([...run]);
  }
  for(let c=0;c<WIDTH;c++){
    let run=[c];
    for(let r=1;r<HEIGHT;r++){
      const p=(r-1)*WIDTH+c,i=r*WIDTH+c;
      if(bd[i] && bd[p] && bd[i].src===bd[p].src) run.push(i);
      else { if(run.length>=3) matches.push([...run]); run=[i]; }
    }
    if(run.length>=3) matches.push([...run]);
  }
  return matches;
}

/* resolve chain (pop -> gravity -> refill) */
function resolveChain(){
  if(locked) return;
  locked=true; state.combo=1;
  (function step(){
    const matches = findMatches(state.board);
    if(matches.length===0){ locked=false; updateHUD(); return; }
    const removeSet = new Set();
    matches.forEach(run=>run.forEach(i=>removeSet.add(i)));
    const removeIdx = Array.from(removeSet).sort((a,b)=>a-b);
    const removedCount = removeIdx.length;
    state.score += removedCount * 10 * state.combo;
    state.combo++;
    updateHUD();

    removeIdx.forEach(i=>{ const el=grid.querySelector(`.cell[data-index='${i}']`); if(el) el.classList.add('pop'); state.board[i]=null; });

    setTimeout(()=>{
      const cols=[];
      for(let c=0;c<WIDTH;c++){
        const col=[];
        for(let r=HEIGHT-1;r>=0;r--){ const idx=r*WIDTH+c; if(state.board[idx]) col.push(state.board[idx]); }
        cols.push(col);
      }
      const newBoard = new Array(SIZE).fill(null);
      const dropMap = {};
      const tilePx = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tile'))||64;
      const oldIds = new Set(state.board.filter(Boolean).map(t=>t.id));
      for(let c=0;c<WIDTH;c++){
        const col = cols[c];
        while(col.length < HEIGHT) col.push(randTile());
        for(let r=HEIGHT-1,i=0;r>=0;r--,i++){
          const tile = col[i];
          newBoard[r*WIDTH+c] = tile;
          if(!oldIds.has(tile.id)) dropMap[tile.id] = `-${(i+1)*tilePx}px`;
        }
      }
      state.board = newBoard;
      fitTiles(); render(dropMap);
      setTimeout(()=> setTimeout(step, 180), parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fall-dur'))||320);
    }, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pop-dur'))||300);
  })();
}

/* input handlers */
let dragging=false, pointerId=null, lastIndex=null;
function onPointerDown(e){
  if(locked) return;
  const el = e.currentTarget; el.setPointerCapture && el.setPointerCapture(e.pointerId);
  dragging=true; pointerId=e.pointerId; lastIndex = Number(el.dataset.index);
  document.addEventListener('pointermove', onPointerMove, {passive:true});
  document.addEventListener('pointerup', onPointerUp);
}
function onPointerMove(e){
  if(!dragging || e.pointerId !== pointerId) return;
  const target = document.elementFromPoint(e.clientX,e.clientY);
  if(!target) return;
  const cell = target.closest && target.closest('.cell') ? target.closest('.cell') : null;
  if(!cell) return;
  const idx = Number(cell.dataset.index);
  if(Number.isNaN(idx)) return;
  if(isAdjacent(lastIndex, idx) && idx !== lastIndex){
    swap(lastIndex, idx); render();
    state.moves = Math.max(0, state.moves-1); updateHUD();
    const matches = findMatches(state.board);
    if(matches.length>0) resolveChain();
    else setTimeout(()=>{ swap(lastIndex, idx); render(); }, 200);
    lastIndex = idx;
  }
}
function onPointerUp(e){
  dragging=false; pointerId=null; lastIndex=null;
  document.removeEventListener('pointermove', onPointerMove);
  document.removeEventListener('pointerup', onPointerUp);
}
function isAdjacent(a,b){ if(a==null||b==null) return false; const r1=Math.floor(a/WIDTH), c1=a%WIDTH, r2=Math.floor(b/WIDTH), c2=b%WIDTH; return Math.abs(r1-r2)+Math.abs(c1-c2)===1; }
function swap(i,j){ [state.board[i], state.board[j]] = [state.board[j], state.board[i]]; }

/* bombs */
function useBomb(){
  if(locked) return;
  // pick random index and show bomb image then explode
  const idx = Math.floor(Math.random()*SIZE);
  const tile = { id: state.nextId++, src: BOMB_FILE, power:'bomb' };
  state.board[idx] = tile; render();
  setTimeout(()=> explodeAt(idx), 220);
}
function explodeAt(idx){
  const removed = new Set();
  const r0=Math.floor(idx/WIDTH), c0=idx%WIDTH;
  for(let dr=-1; dr<=1; dr++) for(let dc=-1; dc<=1; dc++){
    const nr=r0+dr, nc=c0+dc;
    if(nr>=0&&nr<HEIGHT&&nc>=0&&nc<WIDTH) removed.add(nr*WIDTH+nc);
  }
  const arr = Array.from(removed);
  arr.forEach(i=>{ const el = grid.querySelector(`.cell[data-index='${i}']`); if(el) el.classList.add('pop'); state.board[i]=null; });
  state.score += arr.length*15; updateHUD();
  setTimeout(()=> resolveChain(), 220);
}

/* HUD + controls */
function updateHUD(){ scoreEl.textContent=state.score; movesEl.textContent=state.moves; comboText.textContent=`Combo √ó${Math.max(1,state.combo-1)}`; progressBar.style.width = Math.min(100,Math.round(state.score/1200*100)) + '%'; }

document.getElementById('restart').addEventListener('click', ()=> initBoard());
document.getElementById('shuffle').addEventListener('click', ()=>{ state.board = state.board.sort(()=>Math.random()-0.5); fitTiles(); render(); });
useBombBtn.addEventListener('click', ()=> useBomb());

/* initialize board */
function initBoard(){
  state.nextId=1; state.board = new Array(SIZE).fill(null).map(()=>randTile());
  let tries=0;
  while(findMatches(state.board).length>0 && tries++ < 600) state.board = new Array(SIZE).fill(null).map(()=>randTile());
  state.score=0; state.moves=40; state.combo=1;
  fitTiles(); render();
}

window.addEventListener('resize', ()=>{ fitTiles(); render(); });

initBoard();

/* debug */
window._cm = { state, render, resolveChain, useBomb, fitTiles };
</script>
</body>
</html>
