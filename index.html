<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ChatApp</title>

<script type="module">
/* ================= IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  GoogleAuthProvider,
  signInWithRedirect,
  getRedirectResult
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc,
  collection, getDocs, addDoc,
  query, orderBy, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA7U96MP2BheQ1ilIUqd2UgycPs8KVC-Gc",
  authDomain: "chatapp-d38d3.firebaseapp.com",
  projectId: "chatapp-d38d3",
  storageBucket: "chatapp-d38d3.firebasestorage.app",
  messagingSenderId: "321814992234",
  appId: "1:321814992234:web:d1d8eb9d63fcafc53ec113"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= GLOBAL ================= */
let currentUser=null;
let currentChatId=null;
let isGroup=false;
let unsub=null;
let allNewChatUsers=[];

/* ================= AUTH ACTIONS ================= */
window.login = async()=>{
  await signInWithEmailAndPassword(auth,email.value.trim(),password.value.trim());
};

window.register = async()=>{
  const cred = await createUserWithEmailAndPassword(auth,email.value.trim(),password.value.trim());
  await setDoc(doc(db,"users",cred.user.uid),{
    uid:cred.user.uid,
    email:cred.user.email,
    name:"",
    photo:"",
    online:true,
    lastSeen:serverTimestamp()
  });
};

const provider = new GoogleAuthProvider();
window.googleLogin = async()=>{
  await signInWithRedirect(auth,provider);
};

window.logout = async()=>{
  if(currentUser){
    await updateDoc(doc(db,"users",currentUser.uid),{
      online:false,lastSeen:serverTimestamp()
    });
  }
  await signOut(auth);
};

/* ===== Handle Google Redirect ===== */
getRedirectResult(auth).then(async(result)=>{
  if(result && result.user){
    const u=result.user;
    await setDoc(doc(db,"users",u.uid),{
      uid:u.uid,
      email:u.email,
      name:u.displayName||"",
      photo:u.photoURL||"",
      online:true,
      lastSeen:serverTimestamp()
    },{merge:true});
  }
}).catch(()=>{});

/* ================= AUTH STATE ================= */
onAuthStateChanged(auth, async(user)=>{
  if(user){
    currentUser=user;
    await updateDoc(doc(db,"users",user.uid),{
      online:true,lastSeen:serverTimestamp()
    });
    loginBox.style.display="none";
    homeBox.style.display="flex";
    chatBox.style.display="none";
    loadUsers();
    loadGroups();
  }else{
    loginBox.style.display="flex";
    homeBox.style.display="none";
    chatBox.style.display="none";
  }
});

/* ================= LOAD USERS (CHATS TAB) ================= */
async function loadUsers(){
  users.innerHTML="";
  const snap=await getDocs(collection(db,"users"));
  snap.forEach(d=>{
    if(d.id!==currentUser.uid){
      const u=d.data();
      const div=document.createElement("div");
      div.className="user";
      div.innerHTML=`
        <img src="${u.photo||'https://via.placeholder.com/40'}">
        <span>${u.name||u.email}</span>
      `;
      div.onclick=()=>openChat(d.id,false,u.name||u.email);
      users.appendChild(div);
    }
  });
}

/* ================= GROUPS ================= */
async function loadGroups(){
  groups.innerHTML="";
  const snap=await getDocs(collection(db,"groups"));
  snap.forEach(d=>{
    const g=d.data();
    if(g.members && g.members.includes(currentUser.uid)){
      const div=document.createElement("div");
      div.className="user";
      div.innerHTML="ðŸ‘¥ <span>"+g.name+"</span>";
      div.onclick=()=>openChat(d.id,true,g.name);
      groups.appendChild(div);
    }
  });
}

window.createGroup = async()=>{
  const name=prompt("Group name");
  if(!name) return;
  await addDoc(collection(db,"groups"),{
    name,
    members:[currentUser.uid],
    createdBy:currentUser.uid,
    createdAt:Date.now()
  });
  loadGroups();
};

/* ================= CHAT ================= */
function chatId(a,b){return [a,b].sort().join("_");}

function openChat(id,group,title){
  homeBox.style.display="none";
  chatBox.style.display="flex";
  chatTitle.textContent=title;
  messages.innerHTML="";
  isGroup=group;
  currentChatId=id;
  if(unsub) unsub();

  const q = group
    ? query(collection(db,"groups",id,"messages"),orderBy("time"))
    : query(collection(db,"chats",chatId(currentUser.uid,id),"messages"),orderBy("time"));

  unsub=onSnapshot(q,(snap)=>{
    messages.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.from===currentUser.uid?"me":"other");
      div.innerHTML=(group?`<small>${m.sender||""}</small><br>`:"")+m.text;
      messages.appendChild(div);
      messages.scrollTop=messages.scrollHeight;
    });
  });
}

window.sendMsg = async()=>{
  if(!msg.value.trim()) return;
  if(isGroup){
    await addDoc(collection(db,"groups",currentChatId,"messages"),{
      text:msg.value,from:currentUser.uid,
      sender:currentUser.email,time:Date.now()
    });
  }else{
    await addDoc(collection(db,"chats",chatId(currentUser.uid,currentChatId),"messages"),{
      text:msg.value,from:currentUser.uid,time:Date.now()
    });
  }
  msg.value="";
};

window.backHome=()=>{
  chatBox.style.display="none";
  homeBox.style.display="flex";
};

/* ================= NEW CHAT + SEARCH ================= */
window.openNewChat = async()=>{
  newChatBox.style.display="flex";
  newChatUsers.innerHTML="";
  newChatSearch.value="";
  allNewChatUsers=[];

  const snap=await getDocs(collection(db,"users"));
  snap.forEach(d=>{
    if(d.id!==currentUser.uid){
      const u=d.data();
      allNewChatUsers.push({
        uid:d.id,
        name:u.name||"",
        email:u.email||"",
        photo:u.photo||""
      });
    }
  });
  renderNewChatUsers(allNewChatUsers);
};

function renderNewChatUsers(list){
  newChatUsers.innerHTML="";
  list.forEach(u=>{
    const div=document.createElement("div");
    div.className="user";
    div.innerHTML=`
      <img src="${u.photo||'https://via.placeholder.com/40'}">
      <span>${u.name||u.email}</span>
    `;
    div.onclick=()=>{
      closeNewChat();
      openChat(u.uid,false,u.name||u.email);
    };
    newChatUsers.appendChild(div);
  });
}

window.filterNewChatUsers=()=>{
  const q=newChatSearch.value.toLowerCase();
  const f=allNewChatUsers.filter(u=>
    u.name.toLowerCase().includes(q) ||
    u.email.toLowerCase().includes(q)
  );
  renderNewChatUsers(f);
};

window.closeNewChat=()=>{
  newChatBox.style.display="none";
};
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins}
body{height:100vh;background:#ece5dd;display:flex;justify-content:center;align-items:center}

/* LOGIN */
.card{width:100%;max-width:420px;background:#fff;padding:24px;border-radius:16px}
input,.btn{width:100%;padding:14px;border-radius:50px;margin-bottom:12px;border:2px solid #25d366}
.btn{background:#25d366;color:#fff}

/* HOME */
.home{width:100%;max-width:420px;height:90vh;background:#fff;border-radius:16px;display:none;flex-direction:column;overflow:hidden}
.topbar{background:#075e54;color:#fff;padding:14px;font-size:18px}
.tabs{display:flex}
.tab{flex:1;padding:12px;border:none;background:none}
.tab.active{color:#25d366;font-weight:600;border-bottom:3px solid #25d366}
.tab-page{display:none;flex:1;overflow:auto}
.tab-page.active{display:block}
.user{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid #eee}
.user img{width:40px;height:40px;border-radius:50%}

/* CHAT */
.chat{width:100%;max-width:420px;height:90vh;background:#fff;border-radius:16px;display:none;flex-direction:column}
.messages{flex:1;padding:10px;overflow:auto;background:#efeae2}
.msg{max-width:70%;padding:10px;border-radius:12px;margin-bottom:8px}
.me{background:#dcf8c6;margin-left:auto}
.other{background:#fff}
.send{display:flex;padding:10px;gap:8px}

/* FAB */
.fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:#25d366;color:#fff;font-size:32px;border:none}

/* NEW CHAT */
.new-chat{position:fixed;inset:0;background:#fff;display:none;flex-direction:column}
.search-box{padding:10px}
.search-box input{width:100%;padding:12px;border-radius:25px;border:none;background:#f0f0f0}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginBox">
  <h2 style="text-align:center;color:#25d366">ChatApp</h2><br>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button class="btn" onclick="login()">Login</button>
  <button class="btn" onclick="register()">Register</button>
  <button class="btn" onclick="googleLogin()">Google Login</button>
</div>

<!-- HOME -->
<div class="home" id="homeBox">
  <div class="topbar">ChatApp</div>
  <div class="tabs">
    <button class="tab active">Chats</button>
    <button class="tab">Status</button>
    <button class="tab">Groups</button>
    <button class="tab">Calls</button>
  </div>
  <div class="tab-page active">
    <div class="users" id="users"></div>
  </div>
  <div class="tab-page">
    <div class="users" id="groups"></div>
  </div>
</div>

<button class="fab" onclick="openNewChat()">+</button>

<!-- NEW CHAT -->
<div class="new-chat" id="newChatBox">
  <div class="topbar"><button onclick="closeNewChat()">â¬…</button> New Chat</div>
  <div class="search-box">
    <input id="newChatSearch" placeholder="Search" oninput="filterNewChatUsers()">
  </div>
  <div class="users" id="newChatUsers"></div>
</div>

<!-- CHAT -->
<div class="chat" id="chatBox">
  <div class="topbar"><button onclick="backHome()">â¬…</button> <span id="chatTitle"></span></div>
  <div class="messages" id="messages"></div>
  <div class="send">
    <input id="msg" placeholder="Message">
    <button class="btn" onclick="sendMsg()">Send</button>
  </div>
</div>

</body>
</html>
